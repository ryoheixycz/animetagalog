<!DOCTYPE html>
<html lang="tl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tagalog - Watch</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8172698611544170"
     crossorigin="anonymous"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
        }
        
        /* Theme toggle */
        .dark {
            color-scheme: dark;
        }
        
        .dark body {
            background-color: #111827;
            color: #f3f4f6;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        
        .episode-btn {
            background-color: #f3f4f6;
            color: #333;
            transition: all 0.2s ease;
            text-align: center;
            border-radius: 4px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dark .episode-btn {
            background-color: #374151;
            color: #e5e7eb;
        }
        
        .episode-btn:hover {
            background-color: #e5e7eb;
        }
        
        .dark .episode-btn:hover {
            background-color: #4b5563;
        }
        
        .episode-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        
        .dark .episode-btn.active {
            background-color: #6366f1;
        }
        
        .plyr {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .control-btn {
            background-color: #f3f4f6;
            color: #333;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .dark .control-btn {
            background-color: #374151;
            color: #e5e7eb;
        }
        
        .control-btn:hover {
            background-color: #e5e7eb;
        }
        
        .dark .control-btn:hover {
            background-color: #4b5563;
        }
        
        .control-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        
        .dark .control-btn.active {
            background-color: #6366f1;
        }
        
        .dropdown-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px 16px;
            padding-right: 32px;
        }
        
        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }
        
        @media (min-width: 640px) {
            .episode-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }
        }
        
        .anime-info-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        /* For better responsiveness */
        @media (max-width: 640px) {
            .control-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        /* Improved player styles */
        .plyr--video {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .plyr__control--overlaid {
            background: rgba(79, 70, 229, 0.8);
        }
        
        .plyr--full-ui input[type=range] {
            color: #4f46e5;
        }
        
        .plyr__control.plyr__tab-focus,
        .plyr__control:hover,
        .plyr__control[aria-expanded=true] {
            background: #4f46e5;
        }
        
        .plyr__menu__container .plyr__control[role=menuitemradio][aria-checked=true]::before {
            background: #4f46e5;
        }
        
        /* Loading spinner */
        .loader {
            border-top-color: #4f46e5;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            transition: all 0.3s ease;
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.hide {
            transform: translateY(20px);
            opacity: 0;
        }
        
        /* Live Chat Styles */
        .chat-container {
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .dark .chat-container {
            background-color: #1f2937;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
        }
        
        .chat-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: #f9fafb;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .dark .chat-header {
            background-color: #374151;
            border-bottom: 1px solid #4b5563;
        }
        
        .live-badge {
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .coming-soon-badge {
            background-color: #EEF2FF;
            color: #4F46E5;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 12px;
            white-space: nowrap;
        }
        
        .dark .coming-soon-badge {
            background-color: #312e81;
            color: #a5b4fc;
        }
        
        .related-anime-item {
            transition: all 0.2s ease;
        }
        
        .related-anime-item:hover {
            transform: translateY(-2px);
        }
        
        /* Ad containers */
        .ad-container {
            width: 100%;
            margin: 1rem auto;
            overflow: hidden;
            text-align: center;
            background-color: #f1f2f6;
            border-radius: 12px;
            padding: 10px;
        }
        
        .dark .ad-container {
            background-color: #374151;
        }
        
        .ad-container-horizontal {
            min-height: 90px;
        }
        
        .ad-container-square {
            min-height: 250px;
        }
        
        .ad-label {
            display: block;
            text-align: center;
            font-size: 10px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        /* Comment section */
        .comment-container {
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .dark .comment-container {
            background-color: #1f2937;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
        }
        
        .comment {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .dark .comment {
            border-bottom: 1px solid #374151;
        }
        
        .comment:last-child {
            border-bottom: none;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #4b5563;
        }
        
        .dark .comment-avatar {
            background-color: #4b5563;
            color: #e5e7eb;
        }
        
        .comment-author {
            font-weight: 600;
            font-size: 14px;
        }
        
        .comment-time {
            margin-left: auto;
            font-size: 12px;
            color: #9ca3af;
        }
        
        .comment-content {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.5;
        }
        
        .dark .comment-content {
            color: #d1d5db;
        }
        
        .comment-form {
            padding: 12px;
            border-top: 1px solid #f3f4f6;
        }
        
        .dark .comment-form {
            border-top: 1px solid #374151;
        }
        
        /* Theme toggle switch */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .4s;
            border-radius: 24px;
        }
        
        .dark .slider {
            background-color: #4b5563;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4f46e5;
        }
        
        input:checked + .slider:before {
            transform: translateX(16px);
        }
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4f46e5;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .notification-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Favorite button */
        .favorite-btn {
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .favorite-btn.active {
            color: #f59e0b;
        }
        
        /* Share options container */
        .share-options {
            display: none;
            position: absolute;
            right: 0;
            top: 42px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 8px;
            width: 180px;
            z-index: 10;
        }
        
        .dark .share-options {
            background-color: #1f2937;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .share-option {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .share-option:hover {
            background-color: #f3f4f6;
        }
        
        .dark .share-option:hover {
            background-color: #374151;
        }
        
        .share-option i {
            margin-right: 8px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <!-- Simple Header -->
    <div class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <a href="index.html" class="text-lg font-bold text-indigo-600 dark:text-indigo-400 flex items-center">
                    <i data-feather="arrow-left" class="h-5 w-5 mr-2"></i>
                    ANIME TAGALOG
                    <span class="ml-2 px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 text-xs rounded">v2.0</span>
                </a>
                
                <div class="flex items-center space-x-3">
                    <label class="theme-switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                    </label>
                    
                    <button id="favoriteBtn" class="favorite-btn text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                        <i data-feather="heart" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 max-w-4xl">
        <!-- Video Player Section -->
        <div id="videoSection" class="mb-4">
            <!-- Video thumbnail (shown before video loads) -->
            <div id="videoThumbnail" class="relative rounded-lg overflow-hidden shadow-sm group cursor-pointer">
                <img src="/api/placeholder/800/450" alt="Video Thumbnail" class="w-full h-auto object-cover">
                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-40 group-hover:bg-opacity-50 transition">
                    <button id="playThumbnail" class="bg-indigo-600 text-white p-4 rounded-full hover:bg-indigo-700 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i data-feather="play" class="h-8 w-8"></i>
                    </button>
                </div>
                <div class="absolute bottom-4 right-4 bg-black bg-opacity-60 text-white px-3 py-1 rounded-full text-sm font-medium">
                    <span id="videoDuration">Loading...</span>
                </div>
                <div class="absolute top-4 left-4 bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                    <span id="episodeLabel">Episode 1</span>
                </div>
                <!-- Server selector overlay (visible at bottom left corner of thumbnail) -->
                <div class="absolute bottom-4 left-4 flex items-center gap-2">
                    <div class="bg-black bg-opacity-60 rounded-full px-3 py-1">
                        <select id="thumbnailServerSelector" class="bg-transparent text-white text-xs border-none focus:outline-none focus:ring-0">
                            <option value="1">Server 1</option>
                            <option value="2" selected>Server 2</option>
                            <option value="3">Server 3</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Video player (hidden initially) -->
            <div id="videoPlayerContainer" class="hidden">
                <video id="player" playsinline controls class="w-full rounded-lg shadow-sm">
                    <source id="videoSource" src="" type="video/mp4">
                    <!-- Fallback for old browsers -->
                    <p>Your browser doesn't support HTML5 video.</p>
                </video>
            </div>
        </div>
        
        <!-- Ad Banner (Under Video) -->
        <div class="ad-container ad-container-horizontal mb-3">
            <span class="ad-label">Advertisement</span>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-8172698611544170"
                 data-ad-slot="1234567890"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <!-- Player Controls -->
        <div class="bg-white dark:bg-gray-800 shadow-sm p-3 mb-3 rounded-lg">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex items-center gap-2">
                    <div class="flex items-center">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoplayToggle" class="form-checkbox h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-xs text-gray-700 dark:text-gray-300 ml-1">Autoplay</span>
                        </label>
                    </div>
                    
                    <button id="autoNextBtn" class="control-btn text-xs">
                        <i data-feather="skip-forward" class="h-3 w-3 mr-1"></i> Auto Next
                    </button>
                    
                    <div>
                        <select id="serverSelector" class="text-xs px-2 py-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="1">Server 1</option>
                            <option value="2" selected>Server 2</option>
                            <option value="3">Server 3</option>
                        </select>
                    </div>

                    <div>
                        <select id="qualitySelector" class="text-xs px-2 py-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="auto" selected>Auto</option>
                            <option value="1080p">1080p</option>
                            <option value="720p">720p</option>
                            <option value="480p">480p</option>
                            <option value="360p">360p</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="prevEpisodeBtn" class="control-btn text-xs">
                        <i data-feather="chevron-left" class="h-3 w-3 mr-1"></i> Prev
                    </button>
                    
                    <button id="nextEpisodeBtn" class="control-btn text-xs">
                        Next <i data-feather="chevron-right" class="h-3 w-3 ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Episode Selector -->
        <div class="bg-white dark:bg-gray-800 shadow-sm p-3 mb-3 rounded-lg">
            <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                <select id="episodeRangeSelect" class="dropdown-select bg-gray-50 dark:bg-gray-700 border-0 rounded-md py-2 px-3 text-xs text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <!-- Will be populated dynamically based on total episodes -->
                </select>
                
                <div class="relative flex-1">
                    <input type="text" placeholder="Filter episodes..." id="filterEpisodes" 
                          class="w-full bg-gray-50 dark:bg-gray-700 border-0 rounded-md py-2 px-3 pr-16 text-xs text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <div class="absolute right-0 top-0 h-full flex items-center pr-2">
                        <button id="viewListBtn" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 p-1">
                            <i data-feather="list" class="h-4 w-4"></i>
                        </button>
                        <button id="viewGridBtn" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 p-1">
                            <i data-feather="grid" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Episode Grid -->
            <div id="episodeGrid" class="episode-grid">
                <!-- This will be populated by JavaScript -->
                <div class="col-span-full flex justify-center py-3">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>
                </div>
            </div>
        </div>
        
        <!-- Ad Banner (Middle) -->
        <div class="ad-container ad-container-horizontal mb-3">
            <span class="ad-label">Advertisement</span>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-8172698611544170"
                 data-ad-slot="2345678901"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
        
        <!-- Anime Info Section -->
        <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg p-4 mb-3">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Anime Image -->
                <div class="w-full md:w-1/4 lg:w-1/5">
                    <img id="animeImage" src="/api/placeholder/300/450" alt="Anime Cover" class="w-full h-auto object-cover rounded-lg shadow-sm">
                    
                    <!-- Quick Actions -->
                    <div class="mt-2 flex flex-wrap gap-1">
                        <button id="downloadBtn" class="w-full py-1 px-2 text-xs bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded flex items-center justify-center">
                            <i data-feather="download" class="h-3 w-3 mr-1"></i> Download
                            <span class="coming-soon-badge ml-1">COMING SOON</span>
                        </button>
                        <div class="relative w-full">
                            <button id="shareBtn" class="w-full py-1 px-2 text-xs bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded flex items-center justify-center">
                                <i data-feather="share-2" class="h-3 w-3 mr-1"></i> Share
                            </button>
                            <div id="shareOptions" class="share-options">
                                <div class="share-option" data-platform="facebook">
                                    <i data-feather="facebook" class="h-4 w-4"></i>
                                    <span class="text-xs">Facebook</span>
                                </div>
                                <div class="share-option" data-platform="twitter">
                                    <i data-feather="twitter" class="h-4 w-4"></i>
                                    <span class="text-xs">Twitter</span>
                                </div>
                                <div class="share-option" data-platform="telegram">
                                    <i data-feather="send" class="h-4 w-4"></i>
                                    <span class="text-xs">Telegram</span>
                                </div>
                                <div class="share-option" data-platform="whatsapp">
                                    <i data-feather="message-circle" class="h-4 w-4"></i>
                                    <span class="text-xs">WhatsApp</span>
                                </div>
                                <div class="share-option" data-platform="copy">
                                    <i data-feather="clipboard" class="h-4 w-4"></i>
                                    <span class="text-xs">Copy Link</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Anime Details -->
                <div class="flex-1">
                    <h1 id="animeTitle" class="text-xl font-bold mb-2 text-gray-900 dark:text-white">Loading anime...</h1>
                    
                    <div id="animeInfo" class="grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 mb-4 text-sm">
                        <div class="flex items-center">
                            <span class="text-gray-500 dark:text-gray-400 w-16 sm:w-20">Status:</span>
                            <span id="animeStatus" class="font-medium text-gray-800 dark:text-gray-200">Loading...</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 dark:text-gray-400 w-16 sm:w-20">Episodes:</span>
                            <span id="animeEpisodes" class="font-medium text-gray-800 dark:text-gray-200">?</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 dark:text-gray-400 w-16 sm:w-20">Year:</span>
                            <span id="animeYear" class="font-medium text-gray-800 dark:text-gray-200">Loading...</span>
                        </div>
                        <div class="flex items-center col-span-2 sm:col-span-1">
                            <span class="text-gray-500 dark:text-gray-400 w-16 sm:w-20">Rating:</span>
                            <span id="animeRating" class="font-medium flex items-center text-gray-800 dark:text-gray-200">
                                <span class="text-yellow-500 mr-1">★</span> ?
                            </span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 dark:text-gray-400 w-16 sm:w-20">Views:</span>
                            <span id="animeViews" class="font-medium text-gray-800 dark:text-gray-200">0</span>
                        </div>
                    </div>
                    
                    <!-- Genres -->
                    <div class="mb-4">
                        <div id="animeGenres" class="flex flex-wrap">
                            <span class="anime-info-tag bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400">Loading genres...</span>
                        </div>
                    </div>
                    
                    <!-- Synopsis -->
                    <div>
                        <h3 class="text-sm font-semibold mb-1 text-gray-800 dark:text-gray-200">Synopsis</h3>
                        <p id="animeSynopsis" class="text-sm text-gray-600 dark:text-gray-400">
                            Loading anime synopsis...
                        </p>
                    </div>

                    <!-- Related Anime (more subtle) -->
                    <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">You might also like:</p>
                        <div id="relatedAnime" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            <div class="bg-gray-50 dark:bg-gray-700 h-10 animate-pulse rounded"></div>
                            <div class="bg-gray-50 dark:bg-gray-700 h-10 animate-pulse rounded"></div>
                            <div class="bg-gray-50 dark:bg-gray-700 h-10 animate-pulse rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg p-4 mb-3">
            <h2 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Comments</h2>
            
            <div class="comment-container mb-4">
                <div class="comment-form border-none">
                    <div class="flex gap-3">
                        <div class="comment-avatar bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300">
                            U
                        </div>
                        <div class="flex-1">
                            <textarea id="commentInput" placeholder="Add a comment..." class="w-full p-2 border dark:border-gray-700 dark:bg-gray-700 dark:text-white rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-sm" rows="2"></textarea>
                            <div class="flex justify-end mt-2">
                                <button id="postCommentBtn" class="px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700">
                                    Post
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="commentsContainer">
                    <!-- Comments will be loaded here -->
                    <div class="comment">
                        <div class="comment-header">
                            <div class="comment-avatar">N</div>
                            <div class="comment-author text-gray-800 dark:text-gray-200">Naruto</div>
                            <div class="comment-time">2 hours ago</div>
                        </div>
                        <div class="comment-content">
                            This episode was amazing! I can't wait for the next one! 🔥
                        </div>
                    </div>
                    
                    <div class="comment">
                        <div class="comment-header">
                            <div class="comment-avatar">L</div>
                            <div class="comment-author text-gray-800 dark:text-gray-200">Luffy</div>
                            <div class="comment-time">4 hours ago</div>
                        </div>
                        <div class="comment-content">
                            The animation quality is getting better with each episode! Love the fight scenes.
                        </div>
                    </div>
                    
                    <div class="comment">
                        <div class="comment-header">
                            <div class="comment-avatar">G</div>
                            <div class="comment-author text-gray-800 dark:text-gray-200">Goku</div>
                            <div class="comment-time">1 day ago</div>
                        </div>
                        <div class="comment-content">
                            Can't believe what happened at the end! Anybody else shocked? 😱
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="loadMoreCommentsBtn" class="w-full py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-600">
                Load More Comments
            </button>
        </div>
        
        <!-- Ad Banner (Bottom) -->
        <div class="ad-container ad-container-horizontal mb-3">
            <span class="ad-label">Advertisement</span>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-8172698611544170"
                 data-ad-slot="3456789012"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
        
        <!-- Live Chat Integration -->
        <div class="mb-3">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="flex items-center">
                        <div class="live-badge"></div>
                        <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Live Chat / Request</span>
                    </div>
                </div>
                <div>
                    <script async="async" data-cfasync="false" id="cid0020000402087194787" src="//st.chatango.com/js/gz/emb.js" style="width: 100%; height: 250px;">
                        {"handle":"animefaiyazzz","arch":"js","styles":{"a":"222222","b":100,"c":"FFFFFF","d":"FFFFFF","k":"222222","l":"222222","m":"222222","n":"FFFFFF","p":"10","q":"222222","r":100,"ab":false,"surl":0,"cnrs":"0.35"}}
                    </script>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification container (for showing alerts) -->
    <div id="notificationContainer" class="fixed bottom-4 right-4 z-50"></div>
    
    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="flex items-center gap-2">
            <i data-feather="info" class="h-4 w-4"></i>
            <span id="notificationMessage">Notification message</span>
        </div>
    </div>

    <script>
        let player;
        let currentAnime = null;
        let currentEpisode = 1;
        let currentServer = 2; // Default to server 2
        let allEpisodes = [];
        let autoplayEnabled = localStorage.getItem('autoplayEnabled') === 'true';
        let autoNextEnabled = localStorage.getItem('autoNextEnabled') === 'true';
        let playerInitialized = false;
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        let recentlyWatched = JSON.parse(localStorage.getItem('recentlyWatched') || '[]');
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // Initialize theme
            initTheme();
            
            // Get anime ID and episode from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const animeId = urlParams.get('id');
            const episodeParam = urlParams.get('ep');
            
            if (animeId) {
                loadAnimeDetails(animeId);
                
                if (episodeParam && !isNaN(episodeParam)) {
                    currentEpisode = parseInt(episodeParam);
                }
                
                // Check if server parameter is present
                const serverParam = urlParams.get('server');
                if (serverParam && (serverParam === '1' || serverParam === '2' || serverParam === '3')) {
                    currentServer = parseInt(serverParam);
                }
                
                // Set server selectors to current server
                document.getElementById('serverSelector').value = currentServer.toString();
                document.getElementById('thumbnailServerSelector').value = currentServer.toString();
            } else {
                showError('No anime selected. Please select an anime from the home page.');
            }
            
            // Setup UI elements and event listeners
            document.getElementById('autoplayToggle').checked = autoplayEnabled;
            if (autoNextEnabled) {
                document.getElementById('autoNextBtn').classList.add('active');
            }
            
            setupEventListeners();
            
            // Update episode label
            document.getElementById('episodeLabel').textContent = `Episode ${currentEpisode}`;
        });
        
        // Initialize theme
        function initTheme() {
            if (darkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeToggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeToggle').checked = false;
            }
        }

        // Load anime details
        function loadAnimeDetails(animeId) {
            fetch(`/api/animes/${animeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    currentAnime = data;
                    document.title = `${data.title} - Episode ${currentEpisode} - Anime Tagalog`;
                    
                    // Update anime info
                    document.getElementById('animeTitle').textContent = data.title || 'Unknown Title';
                    document.getElementById('animeImage').src = data.poster || '/api/placeholder/300/450';
                    document.getElementById('animeImage').alt = data.title || 'Anime Cover';
                    document.getElementById('animeStatus').textContent = data.status || 'Unknown';
                    document.getElementById('animeEpisodes').textContent = data.episodes || '0';
                    document.getElementById('animeYear').textContent = data.year || 'Unknown';
                    document.getElementById('animeViews').textContent = data.views ? data.views.toLocaleString() : '0';
                    
                    // Format rating
                    const rating = parseFloat(data.rating || 0).toFixed(1);
                    document.getElementById('animeRating').innerHTML = `<span class="text-yellow-500 mr-1">★</span> ${rating}`;
                    
                    // Update favorite button
                    updateFavoriteButton();
                    
                    // Update genres
                    const genresContainer = document.getElementById('animeGenres');
                    genresContainer.innerHTML = '';
                    
                    if (data.genres && data.genres.length > 0) {
                        const colors = [
                            'bg-blue-50 text-blue-600 dark:bg-blue-900 dark:text-blue-300',
                            'bg-green-50 text-green-600 dark:bg-green-900 dark:text-green-300',
                            'bg-purple-50 text-purple-600 dark:bg-purple-900 dark:text-purple-300',
                            'bg-red-50 text-red-600 dark:bg-red-900 dark:text-red-300',
                            'bg-yellow-50 text-yellow-600 dark:bg-yellow-900 dark:text-yellow-300',
                            'bg-indigo-50 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300',
                            'bg-pink-50 text-pink-600 dark:bg-pink-900 dark:text-pink-300'
                        ];
                        
                        data.genres.forEach((genre, index) => {
                            const colorClass = colors[index % colors.length];
                            const genreTag = document.createElement('span');
                            genreTag.className = `anime-info-tag ${colorClass}`;
                            genreTag.textContent = genre;
                            genresContainer.appendChild(genreTag);
                        });
                    } else {
                        genresContainer.innerHTML = '<span class="text-gray-500 dark:text-gray-400 text-sm">No genres listed</span>';
                    }
                    
                    // Update synopsis
                    document.getElementById('animeSynopsis').textContent = data.synopsis || 'No synopsis available.';
                    
                    // Set video thumbnail
                    const thumbnail = data.poster || '/api/placeholder/800/450';
                    document.getElementById('videoThumbnail').querySelector('img').src = thumbnail;
                    
                    // Load episodes and set up range options based on total count
                    loadEpisodes(animeId);
                    
                    // Create episode ranges based on actual episode count
                    const totalEpisodes = parseInt(data.episodes) || 0;
                    createEpisodeRanges(totalEpisodes);
                    
                    // Generate initial episode grid based on current episode
                    if (totalEpisodes > 0) {
                        let rangeStart = 1;
                        // Find the appropriate range for the current episode
                        if (currentEpisode > 24) {
                            rangeStart = Math.floor((currentEpisode - 1) / 24) * 24 + 1;
                        }
                        const rangeEnd = Math.min(rangeStart + 23, totalEpisodes);
                        generateEpisodeGrid(rangeStart, rangeEnd);
                    }
                    
                    // Add to recently watched
                    addToRecentlyWatched(animeId);
                    
                    // Load related anime
                    loadRelatedAnime(animeId);

                    // Auto-play if enabled
                    if (autoplayEnabled) {
                        setTimeout(() => {
                            document.getElementById('videoThumbnail').click();
                        }, 500);
                    }
                })
                .catch(error => {
                    console.error('Error loading anime details:', error);
                    showError('Failed to load anime details');
                });
        }
        
        // Update favorite button
        function updateFavoriteButton() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            
            if (currentAnime && favorites.includes(currentAnime.id)) {
                favoriteBtn.classList.add('active');
            } else {
                favoriteBtn.classList.remove('active');
            }
        }
        
        // Add to recently watched
        function addToRecentlyWatched(animeId) {
            animeId = parseInt(animeId);
            
            // Remove if already exists
            const index = recentlyWatched.indexOf(animeId);
            if (index !== -1) {
                recentlyWatched.splice(index, 1);
            }
            
            // Add to the beginning
            recentlyWatched.unshift(animeId);
            
            // Limit to 20 items
            if (recentlyWatched.length > 20) {
                recentlyWatched = recentlyWatched.slice(0, 20);
            }
            
            // Save to localStorage
            localStorage.setItem('recentlyWatched', JSON.stringify(recentlyWatched));
        }
        
        // Load related anime
        function loadRelatedAnime(animeId) {
            fetch(`/api/animes/${animeId}/related`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(related => {
                    const container = document.getElementById('relatedAnime');
                    container.innerHTML = '';
                    
                    if (!related || related.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-xs col-span-full">No related anime found</p>';
                        return;
                    }
                    
                    // Limit to max 4 related anime
                    const relatedShown = related.slice(0, 4);
                    
                    relatedShown.forEach(anime => {
                        const card = document.createElement('a');
                        card.href = `watch.html?id=${anime.id}`;
                        card.className = 'flex items-center p-2 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded related-anime-item';
                        
                        card.innerHTML = `
                            <img src="${anime.poster || '/api/placeholder/60/90'}" alt="${anime.title}" class="h-8 w-5 object-cover mr-2 rounded">
                            <span class="text-xs text-gray-700 dark:text-gray-300 truncate">${anime.title}</span>
                        `;
                        
                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading related anime:', error);
                    const container = document.getElementById('relatedAnime');
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-xs col-span-full">Could not load related anime</p>';
                });
        }

        // Create episode range options based on total episodes
        function createEpisodeRanges(totalEpisodes) {
            const select = document.getElementById('episodeRangeSelect');
            select.innerHTML = '';
            
            if (totalEpisodes <= 0) {
                const option = document.createElement('option');
                option.value = '0-0';
                option.textContent = 'No Episodes';
                select.appendChild(option);
                return;
            }
            
            // Create ranges in batches of 24 episodes
            for (let i = 1; i <= totalEpisodes; i += 24) {
                const end = Math.min(i + 23, totalEpisodes);
                const option = document.createElement('option');
                option.value = `${i}-${end}`;
                option.textContent = `EPS ${i} - ${end}`;
                select.appendChild(option);
            }
            
            // Make sure the range containing the current episode is selected
            setSelectedRange(currentEpisode);
        }

        // Set the selected range based on episode number
        function setSelectedRange(episodeNumber) {
            const select = document.getElementById('episodeRangeSelect');
            
            for (let i = 0; i < select.options.length; i++) {
                const [start, end] = select.options[i].value.split('-').map(Number);
                
                if (episodeNumber >= start && episodeNumber <= end) {
                    select.selectedIndex = i;
                    break;
                }
            }
        }

        // Load episodes
        function loadEpisodes(animeId) {
            fetch(`/api/animes/${animeId}/episodes`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    allEpisodes = data;
                    
                    // If no episodes are available but we know from anime data that there should be episodes,
                    // assume all episodes are available through batch system
                    if ((!allEpisodes || allEpisodes.length === 0) && currentAnime && currentAnime.episodes > 0) {
                        // Create dummy episode data for all episodes
                        allEpisodes = [];
                        for (let i = 1; i <= currentAnime.episodes; i++) {
                            allEpisodes.push({
                                episodeNumber: i,
                                title: `Episode ${i}`,
                                sources: {
                                    server1: `/api/animes/${animeId}/episodes/${i}/server/1`,
                                    server2: `/api/animes/${animeId}/episodes/${i}/server/2`,
                                    server3: `/api/animes/${animeId}/episodes/${i}/server/3`
                                }
                            });
                        }
                    }
                    
                    updateEpisodeInfo(currentEpisode);
                })
                .catch(error => {
                    console.error('Error loading episodes:', error);
                    showNotification('Failed to load episodes. Please try refreshing the page.');
                });
        }

        // Update episode information
        function updateEpisodeInfo(episodeNumber) {
            // Always assume episode exists if we're in range of the anime's episode count
            if (currentAnime && episodeNumber <= currentAnime.episodes) {
                // Update title
                document.getElementById('episodeLabel').textContent = `Episode ${episodeNumber}`;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('change', function() {
                darkMode = this.checked;
                localStorage.setItem('darkMode', darkMode);
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                // Reinitialize feather icons
                feather.replace();
            });
            
            // Favorite button
            document.getElementById('favoriteBtn').addEventListener('click', function() {
                if (!currentAnime) return;
                
                const animeId = currentAnime.id;
                const index = favorites.indexOf(animeId);
                
                if (index === -1) {
                    // Add to favorites
                    favorites.push(animeId);
                    this.classList.add('active');
                    showNotificationToast('Added to favorites');
                } else {
                    // Remove from favorites
                    favorites.splice(index, 1);
                    this.classList.remove('active');
                    showNotificationToast('Removed from favorites');
                }
                
                // Save to localStorage
                localStorage.setItem('favorites', JSON.stringify(favorites));
            });
            
            // Click on thumbnail to play
            document.getElementById('videoThumbnail').addEventListener('click', function() {
                document.getElementById('videoThumbnail').classList.add('hidden');
                document.getElementById('videoPlayerContainer').classList.remove('hidden');
                initializeVideoPlayer();
                loadEpisodeVideo(currentEpisode, currentServer);
            });
            
            // Play thumbnail button
            document.getElementById('playThumbnail').addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering the parent click handler twice
                document.getElementById('videoThumbnail').classList.add('hidden');
                document.getElementById('videoPlayerContainer').classList.remove('hidden');
                initializeVideoPlayer();
                loadEpisodeVideo(currentEpisode, currentServer);
            });
            
            // Autoplay toggle checkbox
            document.getElementById('autoplayToggle').addEventListener('change', function() {
                autoplayEnabled = this.checked;
                localStorage.setItem('autoplayEnabled', autoplayEnabled);
            });
            
            // Auto Next button
            document.getElementById('autoNextBtn').addEventListener('click', function() {
                autoNextEnabled = !autoNextEnabled;
                this.classList.toggle('active');
                localStorage.setItem('autoNextEnabled', autoNextEnabled);
            });
            
            // Previous episode button
            document.getElementById('prevEpisodeBtn').addEventListener('click', function() {
                if (currentEpisode > 1) {
                    navigateToEpisode(currentEpisode - 1, currentServer);
                }
            });
            
            // Next episode button
            document.getElementById('nextEpisodeBtn').addEventListener('click', function() {
                if (currentAnime && currentEpisode < currentAnime.episodes) {
                    navigateToEpisode(currentEpisode + 1, currentServer);
                }
            });
            
            // Episode range select
            document.getElementById('episodeRangeSelect').addEventListener('change', function() {
                const [start, end] = this.value.split('-').map(Number);
                generateEpisodeGrid(start, end);
            });
            
            // Episode filter
            document.getElementById('filterEpisodes').addEventListener('input', function() {
                const filterText = this.value.trim();
                filterEpisodes(filterText);
            });
            
            // View buttons (list/grid)
            document.getElementById('viewListBtn').addEventListener('click', function() {
                const grid = document.getElementById('episodeGrid');
                grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            });
            
            document.getElementById('viewGridBtn').addEventListener('click', function() {
                const grid = document.getElementById('episodeGrid');
                
                if (window.innerWidth >= 640) {
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(45px, 1fr))';
                } else {
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(40px, 1fr))';
                }
            });
            
            // Server selector
            document.getElementById('serverSelector').addEventListener('change', function() {
                currentServer = parseInt(this.value);
                document.getElementById('thumbnailServerSelector').value = this.value;
                
                if (playerInitialized) {
                    loadEpisodeVideo(currentEpisode, currentServer);
                }
                
                // Update URL without reloading page
                const url = new URL(window.location);
                url.searchParams.set('server', currentServer);
                window.history.pushState({}, '', url);
            });
            
            // Thumbnail server selector
            document.getElementById('thumbnailServerSelector').addEventListener('change', function(e) {
                e.stopPropagation(); // Prevent triggering parent click
                currentServer = parseInt(this.value);
                document.getElementById('serverSelector').value = this.value;
                
                // Update URL without reloading page
                const url = new URL(window.location);
                url.searchParams.set('server', currentServer);
                window.history.pushState({}, '', url);
            });
            
            // Quality selector
            document.getElementById('qualitySelector').addEventListener('change', function() {
                if (player && playerInitialized) {
                    // For demo purposes, we're not actually changing quality
                    showNotificationToast(`Quality changed to ${this.value}`);
                }
            });
            
            // Download button
            document.getElementById('downloadBtn').addEventListener('click', function() {
                showNotificationToast('Download functionality coming soon!');
            });
            
            // Share button
            document.getElementById('shareBtn').addEventListener('click', function() {
                const shareOptions = document.getElementById('shareOptions');
                
                if (shareOptions.style.display === 'block') {
                    shareOptions.style.display = 'none';
                } else {
                    shareOptions.style.display = 'block';
                }
            });
            
            // Close share options when clicking outside
            document.addEventListener('click', function(e) {
                const shareOptions = document.getElementById('shareOptions');
                const shareBtn = document.getElementById('shareBtn');
                
                if (!shareBtn.contains(e.target) && !shareOptions.contains(e.target)) {
                    shareOptions.style.display = 'none';
                }
            });
            
            // Share options
            document.querySelectorAll('.share-option').forEach(option => {
                option.addEventListener('click', function() {
                    const platform = this.dataset.platform;
                    shareEpisode(platform);
                });
            });
            
            // Post comment button
            document.getElementById('postCommentBtn').addEventListener('click', function() {
                const commentInput = document.getElementById('commentInput');
                const commentText = commentInput.value.trim();
                
                if (commentText) {
                    addComment(commentText);
                    commentInput.value = '';
                }
            });
            
            // Load more comments button
            document.getElementById('loadMoreCommentsBtn').addEventListener('click', function() {
                loadMoreComments();
            });
            
            // Key navigation
            document.addEventListener('keydown', function(e) {
                // Arrow left: Previous episode
                if (e.key === 'ArrowLeft' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                    if (currentEpisode > 1) {
                        navigateToEpisode(currentEpisode - 1, currentServer);
                    }
                }
                
                // Arrow right: Next episode
                if (e.key === 'ArrowRight' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                    if (currentAnime && currentEpisode < currentAnime.episodes) {
                        navigateToEpisode(currentEpisode + 1, currentServer);
                    }
                }
                
                // Number keys for server selection
                if (e.key === '1' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                    currentServer = 1;
                    document.getElementById('serverSelector').value = '1';
                    document.getElementById('thumbnailServerSelector').value = '1';
                    
                    if (playerInitialized) {
                        loadEpisodeVideo(currentEpisode, currentServer);
                    }
                } else if (e.key === '2' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                    currentServer = 2;
                    document.getElementById('serverSelector').value = '2';
                    document.getElementById('thumbnailServerSelector').value = '2';
                    
                    if (playerInitialized) {
                        loadEpisodeVideo(currentEpisode, currentServer);
                    }
                } else if (e.key === '3' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                    currentServer = 3;
                    document.getElementById('serverSelector').value = '3';
                    document.getElementById('thumbnailServerSelector').value = '3';
                    
                    if (playerInitialized) {
                        loadEpisodeVideo(currentEpisode, currentServer);
                    }
                }
                
                // Space: Toggle play/pause if player is initialized
                if (e.key === ' ' && playerInitialized && document.activeElement.tagName !== 'BUTTON' && 
                    document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'SELECT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    player.togglePlay();
                }
            });
        }
        
        // Add a comment
        function addComment(text) {
            const commentsContainer = document.getElementById('commentsContainer');
            const comment = document.createElement('div');
            comment.className = 'comment';
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            comment.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">U</div>
                    <div class="comment-author text-gray-800 dark:text-gray-200">You</div>
                    <div class="comment-time">just now</div>
                </div>
                <div class="comment-content">
                    ${text}
                </div>
            `;
            
            // Insert at the top
            commentsContainer.insertBefore(comment, commentsContainer.firstChild);
            
            showNotificationToast('Comment posted!');
        }
        
        // Load more comments (simulated)
        function loadMoreComments() {
            const commentsContainer = document.getElementById('commentsContainer');
            const loadMoreBtn = document.getElementById('loadMoreCommentsBtn');
            
            // Show loading state
            loadMoreBtn.textContent = 'Loading...';
            loadMoreBtn.disabled = true;
            
            // Simulate loading delay
            setTimeout(() => {
                // Add more comments
                for (let i = 0; i < 3; i++) {
                    const comment = document.createElement('div');
                    comment.className = 'comment';
                    
                    const names = ['Sakura', 'Ichigo', 'Mikasa', 'Edward', 'Vegeta', 'Eren'];
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    const randomInitial = randomName.charAt(0);
                    
                    const randomDay = Math.floor(Math.random() * 7) + 1;
                    const timeAgo = `${randomDay} days ago`;
                    
                    const comments = [
                        'This anime keeps getting better with each episode!',
                        'I can\'t believe what happened to that character!',
                        'The animation quality is amazing in this scene.',
                        'Does anyone know when the next season will be released?',
                        'I\'ve been waiting for this episode all week!',
                        'The fight scene was epic! 🔥',
                        'Can\'t wait for the next episode!',
                        'The voice acting in this episode was top notch.'
                    ];
                    const randomComment = comments[Math.floor(Math.random() * comments.length)];
                    
                    comment.innerHTML = `
                        <div class="comment-header">
                            <div class="comment-avatar">${randomInitial}</div>
                            <div class="comment-author text-gray-800 dark:text-gray-200">${randomName}</div>
                            <div class="comment-time">${timeAgo}</div>
                        </div>
                        <div class="comment-content">
                            ${randomComment}
                        </div>
                    `;
                    
                    commentsContainer.appendChild(comment);
                }
                
                // Reset button state
                loadMoreBtn.textContent = 'Load More Comments';
                loadMoreBtn.disabled = false;
            }, 1000);
        }

        // Initialize video player
        function initializeVideoPlayer() {
            player = new Plyr('#player', {
                controls: [
                    'play-large', 'play', 'progress', 'current-time', 'mute',
                    'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                ],
                settings: ['captions', 'quality', 'speed', 'loop'],
                keyboard: { focused: true, global: true },
                autoplay: autoplayEnabled
            });
            
            playerInitialized = true;
            
            // Handle auto-next when video ends
            player.on('ended', function() {
                if (autoNextEnabled && currentAnime && currentEpisode < currentAnime.episodes) {
                    navigateToEpisode(currentEpisode + 1, currentServer);
                }
            });
            
            // Update video duration
            player.on('loadedmetadata', function() {
                const duration = player.duration;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                document.getElementById('videoDuration').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            });
            
            // Handle errors
            player.on('error', function(event) {
                console.error('Video playback error. Trying fallback server...', event);
                
                // Try alternate server if current one fails
                if (currentServer === 1) {
                    currentServer = 2;
                    document.getElementById('serverSelector').value = '2';
                    document.getElementById('thumbnailServerSelector').value = '2';
                    loadEpisodeVideo(currentEpisode, currentServer);
                    
                    // Show notification
                    showNotificationToast('Server 1 failed. Switched to Server 2 automatically.');
                } else if (currentServer === 2) {
                    currentServer = 3;
                    document.getElementById('serverSelector').value = '3';
                    document.getElementById('thumbnailServerSelector').value = '3';
                    loadEpisodeVideo(currentEpisode, currentServer);
                    
                    // Show notification
                    showNotificationToast('Server 2 failed. Switched to Server 3 automatically.');
                } else if (currentEpisode < currentAnime.episodes) {
                    // If server 3 fails, try the next episode with server 2
                    navigateToEpisode(currentEpisode + 1, 2);
                    showNotificationToast('Episode not available. Trying next episode.');
                }
            });
        }
        
        // Show notification message
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 notification';
            notification.textContent = message;
            
            const container = document.getElementById('notificationContainer');
            container.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Show notification toast
        function showNotificationToast(message) {
            const toast = document.getElementById('notificationToast');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            toast.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Load episode video
        function loadEpisodeVideo(episodeNumber, serverNumber) {
            if (!currentAnime) return;
            
            // Create the video URL directly - this is crucial for batch episodes
            const videoUrl = `/api/animes/${currentAnime.id}/episodes/${episodeNumber}/server/${serverNumber}`;
            
            // Update video source
            if (player) {
                // Show loading indicator
                player.poster = currentAnime.poster || '/api/placeholder/800/450';
                
                player.source = {
                    type: 'video',
                    sources: [
                        {
                            src: videoUrl,
                            type: 'video/mp4'
                        }
                    ]
                };
                
                // Autoplay
                if (autoplayEnabled) {
                    player.play().catch(error => {
                        console.error('Autoplay was prevented:', error);
                        showNotificationToast('Autoplay was blocked by your browser. Please click play to start video.');
                    });
                }
            } else {
                // If player not initialized yet
                document.getElementById('videoSource').src = videoUrl;
            }
            
            // Update episode info
            updateEpisodeInfo(episodeNumber);
            
            // Update page title
            document.title = `${currentAnime.title} - Episode ${episodeNumber} - Anime Tagalog`;
        }

        // Navigate to episode
        function navigateToEpisode(episodeNumber, serverNumber) {
            // Don't navigate past the total episodes
            if (currentAnime && episodeNumber > currentAnime.episodes) {
                showNotificationToast('This is the last episode.');
                return;
            }
            
            if (episodeNumber < 1) {
                showNotificationToast('This is the first episode.');
                return;
            }
            
            // Update current episode
            currentEpisode = episodeNumber;
            
            // Update URL without reloading page
            const url = new URL(window.location);
            url.searchParams.set('ep', episodeNumber);
            url.searchParams.set('server', serverNumber);
            window.history.pushState({}, '', url);
            
            // Load the video
            if (playerInitialized) {
                loadEpisodeVideo(episodeNumber, serverNumber);
            } else {
                // Update episode label
                document.getElementById('episodeLabel').textContent = `Episode ${episodeNumber}`;
                updateEpisodeInfo(episodeNumber);
            }
            
            // Check if the episode is in the current range
            const select = document.getElementById('episodeRangeSelect');
            const [start, end] = select.value.split('-').map(Number);
            
            if (episodeNumber < start || episodeNumber > end) {
                // Need to update the range
                setSelectedRange(episodeNumber);
                const option = select.options[select.selectedIndex];
                const [newStart, newEnd] = option.value.split('-').map(Number);
                generateEpisodeGrid(newStart, newEnd);
            } else {
                // Just update the active button
                updateEpisodeGridSelection();
            }
        }

        // Generate episode grid
        function generateEpisodeGrid(start, end) {
            const grid = document.getElementById('episodeGrid');
            grid.innerHTML = '';
            
            // Make sure we don't exceed the total episodes
            const totalEpisodes = currentAnime ? (currentAnime.episodes || 0) : 0;
            const actualEnd = Math.min(end, totalEpisodes);
            
            if (totalEpisodes === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-4 text-gray-500 dark:text-gray-400">No episodes available</div>';
                return;
            }
            
            for (let i = start; i <= actualEnd; i++) {
                const button = document.createElement('button');
                button.className = 'episode-btn';
                button.textContent = i;
                
                // Mark current episode
                if (i === currentEpisode) {
                    button.classList.add('active');
                }
                
                // Handle click - all episodes are assumed to be available with batch system
                button.addEventListener('click', function() {
                    navigateToEpisode(i, currentServer);
                });
                
                grid.appendChild(button);
            }
        }

        // Update episode grid selection
        function updateEpisodeGridSelection() {
            const buttons = document.querySelectorAll('.episode-btn');
            buttons.forEach(button => {
                const episodeNum = parseInt(button.textContent);
                if (episodeNum === currentEpisode) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // Filter episodes
        function filterEpisodes(filterText) {
            if (!filterText) {
                // Show all episodes
                document.querySelectorAll('.episode-btn').forEach(btn => {
                    btn.style.display = '';
                });
                return;
            }
            
            // Filter by number
            const filterNum = parseInt(filterText);
            document.querySelectorAll('.episode-btn').forEach(btn => {
                const btnNum = parseInt(btn.textContent);
                if (isNaN(filterNum) || btnNum.toString().includes(filterText)) {
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });
        }
        
        // Share episode
        function shareEpisode(platform) {
            if (!currentAnime) return;
            
            // Create share URL
            const shareUrl = window.location.href;
            const shareTitle = `${currentAnime.title} - Episode ${currentEpisode} - Anime Tagalog`;
            const shareText = `Check out ${currentAnime.title} Episode ${currentEpisode} on Anime Tagalog!`;
            
            let shareLink = '';
            
            switch (platform) {
                case 'facebook':
                    shareLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'twitter':
                    shareLink = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'telegram':
                    shareLink = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
                    break;
                case 'whatsapp':
                    shareLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
                    break;
                case 'copy':
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showNotificationToast('Link copied to clipboard!');
                    }).catch(error => {
                        console.error('Failed to copy:', error);
                        showNotificationToast('Failed to copy link');
                    });
                    
                    // Hide share options
                    document.getElementById('shareOptions').style.display = 'none';
                    return;
                default:
                    // Use Web Share API if available
                    if (navigator.share) {
                        navigator.share({
                            title: shareTitle,
                            text: shareText,
                            url: shareUrl
                        }).catch(error => {
                            console.error('Error sharing:', error);
                        });
                    } else {
                        // Fallback: copy to clipboard
                        navigator.clipboard.writeText(shareUrl).then(() => {
                            showNotificationToast('Link copied to clipboard!');
                        }).catch(error => {
                            console.error('Failed to copy:', error);
                            showNotificationToast('Failed to copy link');
                        });
                    }
                    
                    // Hide share options
                    document.getElementById('shareOptions').style.display = 'none';
                    return;
            }
            
            // Open share link in new window
            window.open(shareLink, '_blank', 'width=600,height=400');
            
            // Hide share options
            document.getElementById('shareOptions').style.display = 'none';
        }

        // Show error message
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="mt-6 p-4 bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                    <div class="flex flex-col items-center p-6 text-center">
                        <i data-feather="alert-circle" class="text-red-500 h-12 w-12 mb-4"></i>
                        <h3 class="text-lg font-medium text-red-800 dark:text-red-400 mb-2">Error</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">${message}</p>
                        <a href="index.html" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            Return to Home
                        </a>
                    </div>
                </div>
            `;
            feather.replace();
        }
    </script>
</body>
</html>
